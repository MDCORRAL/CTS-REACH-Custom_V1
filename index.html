<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dorothy Camp Kirby School - Suspension Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #2C5F8D 0%, #4A90C2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2C5F8D;
        }

        .metric-subtitle {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #555;
        }

        .filter-group select {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-group select:hover {
            border-color: #2C5F8D;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #4A90C2;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: #2C5F8D;
            font-size: 1.3rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        thead {
            background: #2C5F8D;
            color: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        .highlight-total {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dorothy Camp Kirby School</h1>
        <p>Suspension Data Analysis Dashboard - Juvenile Court School</p>
    </div>

    <div class="container">
        <div class="alert alert-info">
            <strong>About this data:</strong> This dashboard displays suspension data for Dorothy Camp Kirby School, a Juvenile Court School operated by Los Angeles County Office of Education. Data spans from 2017-18 to 2023-24 academic years. Note: Some values are suppressed (*) for privacy when student counts are too small.
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be populated by JavaScript -->
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label for="yearFilter">Academic Year:</label>
                <select id="yearFilter">
                    <option value="all">All Years</option>
                </select>

                <label for="groupFilter">Student Group:</label>
                <select id="groupFilter">
                    <option value="all">All Groups</option>
                </select>
            </div>
            <div class="alert alert-info" id="raceNotice" style="margin-top: 1rem;">
                <!-- Race/ethnicity data availability will be described here -->
            </div>
            <div class="alert alert-info" id="groupList" style="margin-top: 1rem;">
                <!-- Group list will be populated by JavaScript -->
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Suspension Rate Trends Over Time</h3>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>Suspension Rates by Student Group (Latest Year)</h3>
                <div class="chart-wrapper">
                    <canvas id="groupChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3>Suspension Types Breakdown</h3>
                <div class="chart-wrapper">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>Enrollment vs Suspensions</h3>
                <div class="chart-wrapper">
                    <canvas id="enrollmentChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>Gender Comparison</h3>
                <div class="chart-wrapper">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="chart-container full-width">
            <h3>Detailed Data Table</h3>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Academic Year</th>
                            <th>Student Group</th>
                            <th>Enrollment</th>
                            <th>Total Suspensions</th>
                            <th>Students Suspended</th>
                            <th>Suspension Rate</th>
                            <th>Violent (Injury)</th>
                            <th>Violent (No Injury)</th>
                            <th>Defiance Only</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};
        let dataSources = { base: false, race: false };
        const expectedRaceGroups = [
            'American Indian or Alaska Native',
            'Asian',
            'Black or African American',
            'Filipino',
            'Hispanic or Latino',
            'Native Hawaiian or Pacific Islander',
            'Two or More Races',
            'White'
        ];
        let missingRaceGroups = [];

        // Load and process data
        async function loadData() {
            try {
                const [baseResult, raceResult] = await Promise.all([
                    fetchCsvData('ev2_DorothyCamp_DataSummary.csv'),
                    fetchCsvData('ev2_DorothyCamp_DataSummary-RACE.csv', true)
                ]);

                dataSources = {
                    base: baseResult.loaded,
                    race: raceResult.loaded
                };

                if (!dataSources.base) {
                    throw new Error('Base summary sheet (ev2_DorothyCamp_DataSummary.csv) is required but could not be loaded.');
                }

                allData = [...baseResult.rows, ...raceResult.rows];

                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please ensure both CSV files are in the same directory.');
            }
        }

        async function fetchCsvData(path, optional = false) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    if (optional) {
                        console.warn(`${path} not found; continuing without it.`);
                        return { loaded: false, rows: [] };
                    }
                    throw new Error(`Failed to load ${path}`);
                }

                const text = await response.text();
                return { loaded: true, rows: parseCsv(text) };
            } catch (error) {
                if (optional) {
                    console.warn(`Optional source ${path} could not be loaded:`, error);
                    return { loaded: false, rows: [] };
                }
                throw error;
            }
        }

        function parseCsv(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            if (!lines.length) return [];

            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const cells = splitCsvLine(line, headers.length);
                const row = headers.reduce((acc, header, idx) => {
                    acc[header] = cells[idx] ?? '';
                    return acc;
                }, {});

                return {
                    academicYear: row['AcademicYear'],
                    schoolName: row['SchoolName'],
                    reportingCategory: row['ReportingCategory'],
                    reportingCategoryDescription: cleanReportingCategory(row['ReportingCategory_Description']),
                    cumulativeEnrollment: cleanValue(row['CumulativeEnrollment']),
                    totalSuspensions: cleanValue(row['Total Suspensions']),
                    uniqueStudentsSuspended: cleanValue(row['Unduplicated Count of Students Suspended (Total)']),
                    uniqueStudentsSuspendedDefianceOnly: cleanValue(row['Unduplicated Count of Students Suspended (Defiance-Only)']),
                    suspensionRate: cleanValue(row['Suspension Rate (Total)']),
                    suspensionsViolentWithInjury: cleanValue(row['Suspension Count Violent Incident (Injury)']),
                    suspensionsViolentNoInjury: cleanValue(row['Suspension Count Violent Incident (No Injury)']),
                    suspensionsWeapons: cleanValue(row['Suspension Count Weapons Possession']),
                    suspensionsDrugs: cleanValue(row['Suspension Count Illicit Drug-Related']),
                    suspensionsDefianceOnly: cleanValue(row['Suspension Count Defiance-Only']),
                    suspensionsOther: cleanValue(row['Suspension Count Other Reasons']),
                    schoolType: row['School Type']
                };
            });
        }

        function splitCsvLine(line, columnCount) {
            const cells = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip escaped quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    cells.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            cells.push(current);

            while (cells.length < columnCount) {
                cells.push('');
            }

            return cells;
        }

        function cleanValue(value) {
            if (value === undefined || value === null) return null;
            const trimmed = value.trim();
            if (trimmed === '' || trimmed === '*') return null;
            const num = Number(trimmed);
            return Number.isNaN(num) ? trimmed : num;
        }

        function cleanReportingCategory(description) {
            if (!description) return description;
            if (description.includes('�') || description.includes('Ð')) {
                return description.replace('2019�20', '2019-20').replace('2019Ð20', '2019-20');
            }
            return description;
        }

        function initializeDashboard() {
            populateFilters();
            computeRaceAvailability();
            const filteredData = getFilteredData();
            updateMetrics(filteredData);
            createCharts(filteredData);
            updateTable(filteredData);
            updateGroupList(filteredData);
        }

        function populateFilters() {
            const years = [...new Set(allData.map(d => d.academicYear))].sort();
            const groups = [...new Set(allData.map(d => d.reportingCategoryDescription))].sort();

            const yearFilter = document.getElementById('yearFilter');
            const groupFilter = document.getElementById('groupFilter');

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });

            yearFilter.addEventListener('change', updateDashboard);
            groupFilter.addEventListener('change', updateDashboard);
        }

        function parseYearValue(yearLabel) {
            if (!yearLabel) return null;
            const parts = yearLabel.split('-');
            const yearNumber = parseInt(parts[0], 10);
            return isNaN(yearNumber) ? null : yearNumber;
        }

        function getFilteredData() {
            const yearFilter = document.getElementById('yearFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;

            return allData.filter(d => {
                const yearMatch = yearFilter === 'all' || d.academicYear === yearFilter;
                const groupMatch = groupFilter === 'all' || d.reportingCategoryDescription === groupFilter;
                return yearMatch && groupMatch;
            });
        }

        function updateMetrics(data) {
            const totalEnrollment = data.reduce((sum, d) => sum + (d.cumulativeEnrollment || 0), 0);
            const totalSuspensions = data.reduce((sum, d) => sum + (d.totalSuspensions || 0), 0);
            const totalStudentsSuspended = data.reduce((sum, d) => sum + (d.uniqueStudentsSuspended || 0), 0);

            const rateRecords = data.filter(d => d.suspensionRate !== null);
            const avgSuspensionRate = rateRecords.length
                ? rateRecords.reduce((sum, d) => sum + d.suspensionRate, 0) / rateRecords.length
                : 0;

            const years = [...new Set(data.map(d => d.academicYear))];
            const latestYear = years
                .map(year => ({ label: year, value: parseYearValue(year) }))
                .filter(y => y.value !== null)
                .sort((a, b) => b.value - a.value)[0]?.label || null;
            const latestYearData = latestYear !== null
                ? data.find(d => d.academicYear === latestYear && d.reportingCategoryDescription === 'Total')
                    || data.find(d => d.academicYear === latestYear)
                : null;

            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Enrollment</div>
                    <div class="metric-value">${totalEnrollment.toLocaleString()}</div>
                    <div class="metric-subtitle">Across all years</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Suspensions</div>
                    <div class="metric-value">${totalSuspensions.toLocaleString()}</div>
                    <div class="metric-subtitle">All incidents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Students Suspended</div>
                    <div class="metric-value">${totalStudentsSuspended.toLocaleString()}</div>
                    <div class="metric-subtitle">Unduplicated count</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Suspension Rate</div>
                    <div class="metric-value">${(avgSuspensionRate * 100).toFixed(1)}%</div>
                    <div class="metric-subtitle">Mean across selected records</div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = metricsHTML;
        }

        function createCharts(data) {
            createTrendChart(data);
            createGroupChart(data);
            createTypeChart(data);
            createEnrollmentChart(data);
            createGenderChart(data);
        }

        function createTrendChart(data) {
            const years = [...new Set(data.map(d => d.academicYear))].sort();
            const rates = years.map(year => {
                const yearRecords = data.filter(d => d.academicYear === year && d.suspensionRate !== null);
                const totalRecord = yearRecords.find(d => d.reportingCategoryDescription === 'Total');
                const record = totalRecord || yearRecords[0];
                return record ? (record.suspensionRate * 100) : null;
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            if (charts.trend) charts.trend.destroy();

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Suspension Rate (%)',
                        data: rates,
                        borderColor: '#2C5F8D',
                        backgroundColor: 'rgba(44, 95, 141, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function createGroupChart(data) {
            const latestData = data
                .filter(d => d.reportingCategoryDescription !== 'Total' && d.suspensionRate !== null)
                .reduce((acc, record) => {
                    const existing = acc.get(record.reportingCategoryDescription);
                    const yearValue = parseYearValue(record.academicYear);

                    if (!existing || (yearValue !== null && yearValue > existing.yearValue)) {
                        acc.set(record.reportingCategoryDescription, {
                            label: record.reportingCategoryDescription,
                            rate: record.suspensionRate * 100,
                            yearValue
                        });
                    }
                    return acc;
                }, new Map());

            const groups = Array.from(latestData.values())
                .sort((a, b) => (b.rate || 0) - (a.rate || 0));

            const labels = groups.map(g => g.label);
            const rates = groups.map(g => g.rate);

            const ctx = document.getElementById('groupChart').getContext('2d');
            if (charts.group) charts.group.destroy();

            charts.group = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Suspension Rate (%)',
                        data: rates,
                        backgroundColor: [
                            '#2C5F8D', '#4A90C2', '#6BB6D6', '#8FD4E8',
                            '#B3E5F5', '#FFB74D', '#FF8A65', '#A1887F',
                            '#90A4AE'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function createTypeChart(data) {
            const types = {
                'Violent (Injury)': data.reduce((sum, d) => sum + (d.suspensionsViolentWithInjury || 0), 0),
                'Violent (No Injury)': data.reduce((sum, d) => sum + (d.suspensionsViolentNoInjury || 0), 0),
                'Weapons': data.reduce((sum, d) => sum + (d.suspensionsWeapons || 0), 0),
                'Drugs': data.reduce((sum, d) => sum + (d.suspensionsDrugs || 0), 0),
                'Defiance Only': data.reduce((sum, d) => sum + (d.suspensionsDefianceOnly || 0), 0),
                'Other': data.reduce((sum, d) => sum + (d.suspensionsOther || 0), 0)
            };

            const ctx = document.getElementById('typeChart').getContext('2d');
            if (charts.type) charts.type.destroy();

            charts.type = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        data: Object.values(types),
                        backgroundColor: [
                            '#D32F2F', '#F44336', '#FF5722', '#FF9800',
                            '#FFC107', '#FFEB3B'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function createEnrollmentChart(data) {
            const years = [...new Set(data.map(d => d.academicYear))].sort();

            const enrollment = years.map(year => {
                const records = data.filter(d => d.academicYear === year);
                return records.reduce((sum, d) => sum + (d.cumulativeEnrollment || 0), 0);
            });

            const suspensions = years.map(year => {
                const records = data.filter(d => d.academicYear === year);
                return records.reduce((sum, d) => sum + (d.totalSuspensions || 0), 0);
            });

            const ctx = document.getElementById('enrollmentChart').getContext('2d');
            if (charts.enrollment) charts.enrollment.destroy();

            charts.enrollment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Enrollment',
                            data: enrollment,
                            backgroundColor: '#4A90C2',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Suspensions',
                            data: suspensions,
                            backgroundColor: '#FF8A65',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Enrollment'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Suspensions'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        function createGenderChart(data) {
            const genderData = data.filter(d =>
                ['Male', 'Female', 'Non-Binary Gender (Beginning 2019-20)'].includes(d.reportingCategoryDescription)
            );

            const years = [...new Set(genderData.map(d => d.academicYear))].sort();

            const datasets = ['Male', 'Female', 'Non-Binary Gender (Beginning 2019-20)'].map((gender, idx) => {
                const data = years.map(year => {
                    const record = genderData.find(d =>
                        d.academicYear === year && d.reportingCategoryDescription === gender
                    );
                    return record ? (record.suspensionRate * 100) : null;
                });

                return {
                    label: gender.replace(' (Beginning 2019-20)', ''),
                    data: data,
                    borderColor: ['#2C5F8D', '#FF8A65', '#9C27B0'][idx],
                    backgroundColor: ['rgba(44, 95, 141, 0.1)', 'rgba(255, 138, 101, 0.1)', 'rgba(156, 39, 176, 0.1)'][idx],
                    borderWidth: 2,
                    fill: false
                };
            });

            const ctx = document.getElementById('genderChart').getContext('2d');
            if (charts.gender) charts.gender.destroy();

            charts.gender = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tableBody = document.getElementById('tableBody');

            const rows = data.map(d => {
                const isTotal = d.reportingCategoryDescription === 'Total';
                return `
                    <tr class="${isTotal ? 'highlight-total' : ''}">
                        <td>${d.academicYear}</td>
                        <td>${d.reportingCategoryDescription}</td>
                        <td>${d.cumulativeEnrollment !== null ? d.cumulativeEnrollment.toLocaleString() : 'N/A'}</td>
                        <td>${d.totalSuspensions !== null ? d.totalSuspensions.toLocaleString() : 'N/A'}</td>
                        <td>${d.uniqueStudentsSuspended !== null ? d.uniqueStudentsSuspended.toLocaleString() : 'N/A'}</td>
                        <td>${d.suspensionRate !== null ? (d.suspensionRate * 100).toFixed(1) + '%' : 'N/A'}</td>
                        <td>${d.suspensionsViolentWithInjury !== null ? d.suspensionsViolentWithInjury : 'N/A'}</td>
                        <td>${d.suspensionsViolentNoInjury !== null ? d.suspensionsViolentNoInjury : 'N/A'}</td>
                        <td>${d.suspensionsDefianceOnly !== null ? d.suspensionsDefianceOnly : 'N/A'}</td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function updateGroupList(data) {
            const container = document.getElementById('groupList');
            if (!container) return;

            const groups = [...new Set(data.map(d => d.reportingCategoryDescription))].sort();
            if (!groups.length) {
                container.textContent = 'No student groups available for the current filters.';
                return;
            }

            container.innerHTML = `
                <strong>Groups in view:</strong> ${groups.join(', ')}
                <br><small>Group chart uses the latest available year for each listed group.</small>
            `;
        }

        function computeRaceAvailability() {
            const groups = new Set(allData.map(d => d.reportingCategoryDescription));
            missingRaceGroups = expectedRaceGroups.filter(group => !groups.has(group));
            updateRaceNotice();
        }

        function updateRaceNotice() {
            const notice = document.getElementById('raceNotice');
            if (!notice) return;

            const raceSourceMissing = !dataSources.race;

            if (raceSourceMissing) {
                notice.innerHTML = `
                    <strong>Race/Ethnicity data file missing:</strong> The race data sheet (ev2_DorothyCamp_DataSummary-RACE.csv)
                    could not be loaded. Please place it alongside the dashboard files so all race/ethnicity groups appear in the
                    filters and charts.
                `;
                return;
            }

            if (missingRaceGroups.length === expectedRaceGroups.length) {
                notice.innerHTML = `
                    <strong>Race/Ethnicity data unavailable:</strong> The combined data does not contain any race/ethnicity
                    categories (expected: ${expectedRaceGroups.join(', ')}). These groups cannot be displayed until they are
                    included in the source sheets.
                `;
                return;
            }

            if (missingRaceGroups.length) {
                notice.innerHTML = `
                    <strong>Partial race/ethnicity coverage:</strong> Missing categories from the source data:
                    ${missingRaceGroups.join(', ')}. All available categories from both sheets are included in the filters and
                    charts.
                `;
            } else {
                notice.innerHTML = `
                    <strong>Race/Ethnicity categories available:</strong> All expected race/ethnicity groups appear in the
                    combined data and respond to the filters above.
                `;
            }
        }

        function updateDashboard() {
            const filteredData = getFilteredData();
            updateMetrics(filteredData);
            createCharts(filteredData);
            updateTable(filteredData);
            updateGroupList(filteredData);
        }

        // Initialize dashboard when page loads
        loadData();
    </script>
</body>
</html>
