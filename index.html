<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dorothy Camp Kirby School - Suspension Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #2C5F8D 0%, #4A90C2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2C5F8D;
        }

        .metric-subtitle {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #555;
        }

        .filter-group select {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-group select:hover {
            border-color: #2C5F8D;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #4A90C2;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: #2C5F8D;
            font-size: 1.3rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        thead {
            background: #2C5F8D;
            color: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        .highlight-total {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dorothy Camp Kirby School</h1>
        <p>Suspension Data Analysis Dashboard - Juvenile Court School</p>
    </div>

    <div class="container">
        <div class="alert alert-info">
            <strong>About this data:</strong> This dashboard displays suspension data for Dorothy Camp Kirby School, a Juvenile Court School operated by Los Angeles County Office of Education. Data spans from 2017-18 to 2023-24 academic years. Note: Some values are suppressed (*) for privacy when student counts are too small.
        </div>

        <!-- Key Metrics -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Key Metrics Summary</h3>
            <div class="filter-group" style="margin-bottom: 1rem;">
                <label for="metricsYearFilter">Year:</label>
                <select id="metricsYearFilter">
                    <option value="all">All Years</option>
                </select>
            </div>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> These metrics aggregate data from the selected year(s). "Total Enrollment" and "Total Suspensions" are summed from official Total rows only (avoiding double-counting). "Students Suspended" counts unique students. "Avg Suspension Rate" is the mean suspension rate across selected years.</p>
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be populated by JavaScript -->
            </div>
        </div>

        <!-- Data Availability Notice -->
        <div class="alert alert-info" id="raceNotice" style="margin-bottom: 2rem;">
            <!-- Race/ethnicity data availability will be described here -->
        </div>

        <!-- Chart 1: Suspension Rate Trends Over Time -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Suspension Rate Trends Over Time</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This chart shows the suspension rate (%) over time for the selected student group(s). The suspension rate is calculated as: (Students Suspended / Cumulative Enrollment) × 100. When "All Groups" is selected, the "Total" row for each year is used. Filters below affect ONLY this chart.</p>
            <div class="filter-group" style="margin-bottom: 1rem;">
                <label for="trendYearFilter">Academic Year:</label>
                <select id="trendYearFilter">
                    <option value="all">All Years</option>
                </select>

                <label for="trendGroupFilter">Student Group:</label>
                <select id="trendGroupFilter">
                    <option value="all">All Groups</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Suspension Rates by Student Group -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Suspension Rates by Student Group</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This horizontal bar chart compares suspension rates across different student groups for a selected year. Groups are sorted by suspension rate (highest to lowest). You can filter by category type (Race vs Non-Race). Filters below affect ONLY this chart.</p>
            <div class="filter-group" style="margin-bottom: 1rem;">
                <label for="groupChartYearFilter">Year:</label>
                <select id="groupChartYearFilter">
                    <option value="latest">Latest Year</option>
                </select>

                <label for="groupChartCategoryFilter">Category:</label>
                <select id="groupChartCategoryFilter">
                    <option value="non-race">Non-Race Categories</option>
                    <option value="race">Race/Ethnicity Groups</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="groupChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Suspension Types Breakdown -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Suspension Types Breakdown - Year over Year Trends</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This line chart shows the percentage composition of suspension types over time. Each line represents one suspension type (Violent with Injury, Violent without Injury, Weapons, Drugs, Defiance Only, Other). Percentages are calculated as: (Type Count / Total Suspensions) × 100 for each year. This shows how the composition of suspension types changes over time, not the volume. Filters below affect ONLY this chart.</p>
            <div class="filter-group" style="margin-bottom: 1rem;">
                <label for="typeChartYearFilter">Year Range:</label>
                <select id="typeChartYearFilter">
                    <option value="all">All Years</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Chart 4: Enrollment vs Suspensions (Static - No Filters) -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Enrollment vs Suspensions</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This dual-axis bar chart shows total enrollment (left axis) and total suspensions (right axis) for each academic year. Data is from official "Total" rows only (avoiding double-counting). This chart is static and shows all available years. No filters affect this chart.</p>
            <div class="chart-wrapper">
                <canvas id="enrollmentChart"></canvas>
            </div>
        </div>

        <!-- Chart 5: Group Comparison Over Time -->
        <div class="chart-container full-width" style="margin-bottom: 2rem;">
            <h3>Group Comparison Over Time</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This multi-line chart compares suspension rates across selected groups over all available years. Choose to compare Gender, Race/Ethnicity, Other Demographics, or the Top 5 groups with highest total suspension incidents. Each line represents one student group's suspension rate trend. Filters below affect ONLY this chart.</p>
            <div class="filter-group" style="margin-bottom: 1rem;">
                <label for="comparisonFilter">Compare:</label>
                <select id="comparisonFilter">
                    <option value="gender">Gender Categories</option>
                    <option value="race">Race/Ethnicity Groups</option>
                    <option value="other">Other Categories</option>
                    <option value="top5">Top 5 Highest Suspension Groups</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="genderChart"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="chart-container full-width">
            <h3>Detailed Data Table</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Methodology:</strong> This table displays all suspension data for selected years. Each row represents one student group for one academic year. "Total" rows (highlighted in yellow) represent school-wide totals. All suspension type columns (Violent with/without Injury, Weapons, Drugs, Defiance Only, Other) are included. Duplicate "Total" rows from the race data file are excluded to avoid double-counting. Use checkboxes to select years, then click "Download CSV" to export.</p>
            <div class="filter-group" style="margin-bottom: 1rem; display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                <div>
                    <strong>Filter by Year:</strong>
                    <div id="tableYearFilters" style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <!-- Year checkboxes will be populated by JavaScript -->
                    </div>
                </div>
                <button id="downloadCsvBtn" style="padding: 0.75rem 1.5rem; background: #2C5F8D; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                    Download CSV
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Academic Year</th>
                            <th>Student Group</th>
                            <th>Enrollment</th>
                            <th>Total Suspensions</th>
                            <th>Students Suspended</th>
                            <th>Suspension Rate</th>
                            <th>Violent (Injury)</th>
                            <th>Violent (No Injury)</th>
                            <th>Weapons</th>
                            <th>Drugs</th>
                            <th>Defiance Only</th>
                            <th>Other</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};
        let dataSources = { base: false, race: false };
        const expectedRaceGroups = [
            'American Indian or Alaska Native',
            'Asian',
            'Black or African American',
            'Filipino',
            'Hispanic or Latino',
            'Native Hawaiian or Pacific Islander',
            'Two or More Races',
            'White'
        ];
        let missingRaceGroups = [];

        // Load and process data
        async function loadData() {
            try {
                const cleanJson = await fetchJsonData('dorothy_camp_clean_data.json');

                if (cleanJson.loaded) {
                    allData = cleanJson.rows;
                    dataSources = {
                        base: cleanJson.sources.has('ev2_DorothyCamp_DataSummary.csv'),
                        race: cleanJson.sources.has('ev2_DorothyCamp_DataSummary-RACE.csv')
                    };
                } else {
                    const [baseResult, raceResult] = await Promise.all([
                        fetchCsvData('ev2_DorothyCamp_DataSummary.csv'),
                        fetchCsvData('ev2_DorothyCamp_DataSummary-RACE.csv', true)
                    ]);

                    dataSources = {
                        base: baseResult.loaded,
                        race: raceResult.loaded
                    };

                    if (!dataSources.base) {
                        throw new Error('Base summary sheet (ev2_DorothyCamp_DataSummary.csv) is required but could not be loaded.');
                    }

                    allData = [...baseResult.rows, ...raceResult.rows];
                }

                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please ensure both CSV files or the combined JSON are in the same directory.');
            }
        }

        async function fetchJsonData(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) return { loaded: false, rows: [], sources: new Set() };

                const json = await response.json();
                const rows = json.map(normalizeCleanRow);
                const sources = new Set(json.map(r => r.sourceFile).filter(Boolean));
                return { loaded: true, rows, sources };
            } catch (error) {
                console.warn(`Combined JSON ${path} could not be loaded:`, error);
                return { loaded: false, rows: [], sources: new Set() };
            }
        }

        async function fetchCsvData(path, optional = false) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    if (optional) {
                        console.warn(`${path} not found; continuing without it.`);
                        return { loaded: false, rows: [] };
                    }
                    throw new Error(`Failed to load ${path}`);
                }

                const text = await response.text();
                return { loaded: true, rows: parseCsv(text) };
            } catch (error) {
                if (optional) {
                    console.warn(`Optional source ${path} could not be loaded:`, error);
                    return { loaded: false, rows: [] };
                }
                throw error;
            }
        }

        function normalizeCleanRow(row) {
            return {
                academicYear: row.academicYear ?? row['AcademicYear'],
                schoolName: row.schoolName ?? row['SchoolName'],
                reportingCategory: row.reportingCategory ?? row['ReportingCategory'],
                reportingCategoryDescription: cleanReportingCategory(row.reportingCategoryDescription ?? row['ReportingCategory_Description']),
                cumulativeEnrollment: cleanValue(row.cumulativeEnrollment ?? row['CumulativeEnrollment']),
                totalSuspensions: cleanValue(row.totalSuspensions ?? row['Total Suspensions']),
                uniqueStudentsSuspended: cleanValue(row.uniqueStudentsSuspended ?? row['Unduplicated Count of Students Suspended (Total)']),
                uniqueStudentsSuspendedDefianceOnly: cleanValue(row.uniqueStudentsSuspendedDefianceOnly ?? row['Unduplicated Count of Students Suspended (Defiance-Only)']),
                suspensionRate: cleanValue(row.suspensionRate ?? row['Suspension Rate (Total)']),
                suspensionsViolentWithInjury: cleanValue(row.suspensionsViolentWithInjury ?? row['Suspension Count Violent Incident (Injury)']),
                suspensionsViolentNoInjury: cleanValue(row.suspensionsViolentNoInjury ?? row['Suspension Count Violent Incident (No Injury)']),
                suspensionsWeapons: cleanValue(row.suspensionsWeapons ?? row['Suspension Count Weapons Possession']),
                suspensionsDrugs: cleanValue(row.suspensionsDrugs ?? row['Suspension Count Illicit Drug-Related']),
                suspensionsDefianceOnly: cleanValue(row.suspensionsDefianceOnly ?? row['Suspension Count Defiance-Only']),
                suspensionsOther: cleanValue(row.suspensionsOther ?? row['Suspension Count Other Reasons']),
                schoolType: row.schoolType ?? row['School Type'],
                sourceFile: row.sourceFile
            };
        }

        function parseCsv(text) {
            const lines = text.split(/\r?\n/).filter(Boolean);
            if (!lines.length) return [];

            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const cells = splitCsvLine(line, headers.length);
                const row = headers.reduce((acc, header, idx) => {
                    acc[header] = cells[idx] ?? '';
                    return acc;
                }, {});

                return {
                    academicYear: row['AcademicYear'],
                    schoolName: row['SchoolName'],
                    reportingCategory: row['ReportingCategory'],
                    reportingCategoryDescription: cleanReportingCategory(row['ReportingCategory_Description']),
                    cumulativeEnrollment: cleanValue(row['CumulativeEnrollment']),
                    totalSuspensions: cleanValue(row['Total Suspensions']),
                    uniqueStudentsSuspended: cleanValue(row['Unduplicated Count of Students Suspended (Total)']),
                    uniqueStudentsSuspendedDefianceOnly: cleanValue(row['Unduplicated Count of Students Suspended (Defiance-Only)']),
                    suspensionRate: cleanValue(row['Suspension Rate (Total)']),
                    suspensionsViolentWithInjury: cleanValue(row['Suspension Count Violent Incident (Injury)']),
                    suspensionsViolentNoInjury: cleanValue(row['Suspension Count Violent Incident (No Injury)']),
                    suspensionsWeapons: cleanValue(row['Suspension Count Weapons Possession']),
                    suspensionsDrugs: cleanValue(row['Suspension Count Illicit Drug-Related']),
                    suspensionsDefianceOnly: cleanValue(row['Suspension Count Defiance-Only']),
                    suspensionsOther: cleanValue(row['Suspension Count Other Reasons']),
                    schoolType: row['School Type']
                };
            });
        }

        function splitCsvLine(line, columnCount) {
            const cells = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip escaped quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    cells.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            cells.push(current);

            while (cells.length < columnCount) {
                cells.push('');
            }

            return cells;
        }

        function cleanValue(value) {
            if (value === undefined || value === null) return null;

            // Preserve numeric values coming from pre-cleaned JSON
            if (typeof value === 'number') return value;

            const trimmed = String(value).trim();
            if (trimmed === '' || trimmed === '*') return null;
            const num = Number(trimmed);
            return Number.isNaN(num) ? trimmed : num;
        }

        function cleanReportingCategory(description) {
            if (!description) return description;
            if (description.includes('�') || description.includes('Ð')) {
                return description.replace('2019�20', '2019-20').replace('2019Ð20', '2019-20');
            }
            return description;
        }

        function initializeDashboard() {
            populateFilters();
            computeRaceAvailability();

            // Initialize metrics with their own filter
            const metricsData = getFilteredDataForMetrics();
            updateMetrics(metricsData);

            // Initialize trend chart with its own filter
            const trendData = getFilteredDataForTrend();
            createTrendChart(trendData);

            // Initialize other charts with all data
            createGroupChart(allData);
            createTypeChart(allData);
            createEnrollmentChart(allData);
            createGenderChart(allData);

            // Initialize table with its own year checkboxes
            updateTable();
        }

        function populateFilters() {
            const years = [...new Set(allData.map(d => d.academicYear))].sort();
            const groups = [...new Set(allData.map(d => d.reportingCategoryDescription))].sort();

            // Populate metrics year filter
            const metricsYearFilter = document.getElementById('metricsYearFilter');
            if (metricsYearFilter) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    metricsYearFilter.appendChild(option);
                });
                metricsYearFilter.addEventListener('change', () => {
                    const filteredData = getFilteredDataForMetrics();
                    updateMetrics(filteredData);
                });
            }

            // Populate trend chart filters
            const trendYearFilter = document.getElementById('trendYearFilter');
            const trendGroupFilter = document.getElementById('trendGroupFilter');

            if (trendYearFilter) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    trendYearFilter.appendChild(option);
                });
                trendYearFilter.addEventListener('change', () => {
                    const filteredData = getFilteredDataForTrend();
                    createTrendChart(filteredData);
                });
            }

            if (trendGroupFilter) {
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    trendGroupFilter.appendChild(option);
                });
                trendGroupFilter.addEventListener('change', () => {
                    const filteredData = getFilteredDataForTrend();
                    createTrendChart(filteredData);
                });
            }

            // Populate group chart year filter
            const groupChartYearFilter = document.getElementById('groupChartYearFilter');
            if (groupChartYearFilter) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    groupChartYearFilter.appendChild(option);
                });
                groupChartYearFilter.addEventListener('change', () => createGroupChart(allData));
            }

            // Add listener for group chart category filter
            const groupChartCategoryFilter = document.getElementById('groupChartCategoryFilter');
            if (groupChartCategoryFilter) {
                groupChartCategoryFilter.addEventListener('change', () => createGroupChart(allData));
            }

            // Populate type chart year filter
            const typeChartYearFilter = document.getElementById('typeChartYearFilter');
            if (typeChartYearFilter) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    typeChartYearFilter.appendChild(option);
                });
                typeChartYearFilter.addEventListener('change', () => createTypeChart(allData));
            }

            // Add listener for comparison filter
            const comparisonFilter = document.getElementById('comparisonFilter');
            if (comparisonFilter) {
                comparisonFilter.addEventListener('change', () => createGenderChart(allData));
            }

            // Populate table year checkboxes
            const tableYearFilters = document.getElementById('tableYearFilters');
            if (tableYearFilters) {
                years.forEach(year => {
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '0.25rem';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = year;
                    checkbox.checked = true;
                    checkbox.className = 'tableYearCheckbox';
                    checkbox.addEventListener('change', updateTable);

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(year));
                    tableYearFilters.appendChild(label);
                });
            }

            // Add CSV download listener
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            if (downloadCsvBtn) {
                downloadCsvBtn.addEventListener('click', downloadTableAsCSV);
            }
        }

        function parseYearValue(yearLabel) {
            if (!yearLabel) return null;
            const parts = yearLabel.split('-');
            const yearNumber = parseInt(parts[0], 10);
            return isNaN(yearNumber) ? null : yearNumber;
        }

        function getFilteredDataForMetrics() {
            const yearFilter = document.getElementById('metricsYearFilter')?.value || 'all';

            return allData.filter(d => {
                const yearMatch = yearFilter === 'all' || d.academicYear === yearFilter;
                return yearMatch;
            });
        }

        function getFilteredDataForTrend() {
            const yearFilter = document.getElementById('trendYearFilter')?.value || 'all';
            const groupFilter = document.getElementById('trendGroupFilter')?.value || 'all';

            return allData.filter(d => {
                const yearMatch = yearFilter === 'all' || d.academicYear === yearFilter;
                const groupMatch = groupFilter === 'all' || d.reportingCategoryDescription === groupFilter;
                return yearMatch && groupMatch;
            });
        }

        function updateMetrics(data) {
            // CRITICAL: Only use "Total" rows from base CSV to avoid double-counting
            // Both CSVs have identical "Total" rows for each year, so using both doubles the counts
            const totalRecords = data.filter(d =>
                d.reportingCategoryDescription === 'Total' &&
                (d.sourceFile === 'ev2_DorothyCamp_DataSummary.csv' || !d.sourceFile)
            );

            const totalEnrollment = totalRecords.reduce((sum, d) => sum + (d.cumulativeEnrollment || 0), 0);
            const totalSuspensions = totalRecords.reduce((sum, d) => sum + (d.totalSuspensions || 0), 0);
            const totalStudentsSuspended = totalRecords.reduce((sum, d) => sum + (d.uniqueStudentsSuspended || 0), 0);

            const rateRecords = totalRecords.filter(d => d.suspensionRate !== null);
            const avgSuspensionRate = rateRecords.length
                ? rateRecords.reduce((sum, d) => sum + d.suspensionRate, 0) / rateRecords.length
                : 0;

            const yearFilter = document.getElementById('metricsYearFilter')?.value || 'all';
            const yearContext = yearFilter === 'all'
                ? 'Across all available years'
                : `for ${yearFilter}`;
            const rateContext = yearFilter === 'all'
                ? 'Mean across all available years'
                : `Mean for ${yearFilter}`;

            const years = [...new Set(data.map(d => d.academicYear))];
            const latestYear = years
                .map(year => ({ label: year, value: parseYearValue(year) }))
                .filter(y => y.value !== null)
                .sort((a, b) => b.value - a.value)[0]?.label || null;
            const latestYearData = latestYear !== null
                ? data.find(d => d.academicYear === latestYear && d.reportingCategoryDescription === 'Total')
                    || data.find(d => d.academicYear === latestYear)
                : null;

            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Enrollment</div>
                    <div class="metric-value">${totalEnrollment.toLocaleString()}</div>
                    <div class="metric-subtitle">Enrollment ${yearContext}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Suspensions</div>
                    <div class="metric-value">${totalSuspensions.toLocaleString()}</div>
                    <div class="metric-subtitle">Total incidents ${yearContext}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Students Suspended</div>
                    <div class="metric-value">${totalStudentsSuspended.toLocaleString()}</div>
                    <div class="metric-subtitle">Unduplicated count ${yearContext}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Suspension Rate</div>
                    <div class="metric-value">${(avgSuspensionRate * 100).toFixed(1)}%</div>
                    <div class="metric-subtitle">${rateContext}</div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = metricsHTML;
        }

        function createTrendChart(data) {
            const years = [...new Set(data.map(d => d.academicYear))].sort();
            const rates = years.map(year => {
                const yearRecords = data.filter(d => d.academicYear === year && d.suspensionRate !== null);
                const totalRecord = yearRecords.find(d => d.reportingCategoryDescription === 'Total');
                const record = totalRecord || yearRecords[0];
                return record ? (record.suspensionRate * 100) : null;
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            if (charts.trend) charts.trend.destroy();

            // Larger points for better visibility, especially with fewer data points
            const pointRadius = years.length <= 2 ? 8 : (years.length <= 4 ? 6 : 4);
            const pointHoverRadius = pointRadius + 2;

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Suspension Rate (%)',
                        data: rates,
                        borderColor: '#2C5F8D',
                        backgroundColor: 'rgba(44, 95, 141, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: pointRadius,
                        pointHoverRadius: pointHoverRadius,
                        pointBackgroundColor: '#2C5F8D',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function createGroupChart(data) {
            // Get filter values
            const yearFilterValue = document.getElementById('groupChartYearFilter')?.value || 'latest';
            const categoryFilterValue = document.getElementById('groupChartCategoryFilter')?.value || 'non-race';

            // Determine target year
            let targetYear;
            if (yearFilterValue === 'latest') {
                const years = [...new Set(data.map(d => d.academicYear))]
                    .map(year => ({ label: year, value: parseYearValue(year) }))
                    .filter(y => y.value !== null)
                    .sort((a, b) => b.value - a.value);
                targetYear = years[0]?.label;
            } else {
                targetYear = yearFilterValue;
            }

            // Filter data by selected year and category type
            const filteredData = data.filter(d => {
                if (d.reportingCategoryDescription === 'Total') return false;
                if (d.suspensionRate === null) return false;
                if (d.academicYear !== targetYear) return false;

                const category = categorizeGroup(d.reportingCategoryDescription);
                if (categoryFilterValue === 'race') {
                    return category === 'race';
                } else {
                    return category !== 'race' && category !== 'total';
                }
            });

            // Sort by suspension rate
            const groups = filteredData
                .map(d => ({
                    label: d.reportingCategoryDescription,
                    rate: d.suspensionRate * 100
                }))
                .sort((a, b) => (b.rate || 0) - (a.rate || 0));

            const labels = groups.map(g => g.label);
            const rates = groups.map(g => g.rate);

            const ctx = document.getElementById('groupChart').getContext('2d');
            if (charts.group) charts.group.destroy();

            // Generate colors dynamically based on number of groups
            const colorPalette = [
                '#2C5F8D', '#4A90C2', '#6BB6D6', '#8FD4E8',
                '#B3E5F5', '#FFB74D', '#FF8A65', '#A1887F',
                '#90A4AE', '#4CAF50', '#FFC107', '#E91E63',
                '#00BCD4', '#FF5722', '#3F51B5', '#8BC34A'
            ];
            const colors = labels.map((_, idx) => colorPalette[idx % colorPalette.length]);

            charts.group = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Suspension Rate (%)',
                        data: rates,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function createTypeChart(data) {
            // Get filter value
            const yearFilterValue = document.getElementById('typeChartYearFilter')?.value || 'all';

            // Get unique years and filter if needed
            let years = [...new Set(data.map(d => d.academicYear))].sort();
            if (yearFilterValue !== 'all') {
                years = [yearFilterValue];
            }

            // Calculate percentages for each suspension type by year
            const typeNames = [
                'Violent (Injury)',
                'Violent (No Injury)',
                'Weapons',
                'Drugs',
                'Defiance Only',
                'Other'
            ];

            const typeFields = [
                'suspensionsViolentWithInjury',
                'suspensionsViolentNoInjury',
                'suspensionsWeapons',
                'suspensionsDrugs',
                'suspensionsDefianceOnly',
                'suspensionsOther'
            ];

            // Build datasets for each suspension type
            // Larger points for better visibility, especially with fewer years
            const pointRadius = years.length <= 2 ? 8 : (years.length <= 4 ? 6 : 4);
            const pointHoverRadius = pointRadius + 2;

            const datasets = typeNames.map((typeName, idx) => {
                const field = typeFields[idx];

                // Calculate percentage for each year
                const percentages = years.map(year => {
                    const yearRecords = data.filter(d => d.academicYear === year);

                    // Sum up this type for the year
                    const typeTotal = yearRecords.reduce((sum, d) => sum + (d[field] || 0), 0);

                    // Sum up all suspensions for the year
                    const allSuspensions = yearRecords.reduce((sum, d) => sum + (d.totalSuspensions || 0), 0);

                    // Calculate percentage
                    return allSuspensions > 0 ? (typeTotal / allSuspensions) * 100 : 0;
                });

                const borderColor = ['#D32F2F', '#F44336', '#FF5722', '#FF9800', '#FFC107', '#FFEB3B'][idx];

                return {
                    label: typeName,
                    data: percentages,
                    borderColor: borderColor,
                    backgroundColor: ['rgba(211, 47, 47, 0.1)', 'rgba(244, 67, 54, 0.1)', 'rgba(255, 87, 34, 0.1)',
                                     'rgba(255, 152, 0, 0.1)', 'rgba(255, 193, 7, 0.1)', 'rgba(255, 235, 59, 0.1)'][idx],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: pointRadius,
                    pointHoverRadius: pointHoverRadius,
                    pointBackgroundColor: borderColor,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1
                };
            });

            const ctx = document.getElementById('typeChart').getContext('2d');
            if (charts.type) charts.type.destroy();

            charts.type = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage of Total Suspensions (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Academic Year'
                            }
                        }
                    }
                }
            });
        }

        function createEnrollmentChart(data) {
            const years = [...new Set(data.map(d => d.academicYear))].sort();

            // CRITICAL: Only use "Total" rows from base CSV to avoid double-counting
            const enrollment = years.map(year => {
                const totalRecord = data.find(d =>
                    d.academicYear === year &&
                    d.reportingCategoryDescription === 'Total' &&
                    (d.sourceFile === 'ev2_DorothyCamp_DataSummary.csv' || !d.sourceFile)
                );
                return totalRecord ? (totalRecord.cumulativeEnrollment || 0) : 0;
            });

            const suspensions = years.map(year => {
                const totalRecord = data.find(d =>
                    d.academicYear === year &&
                    d.reportingCategoryDescription === 'Total' &&
                    (d.sourceFile === 'ev2_DorothyCamp_DataSummary.csv' || !d.sourceFile)
                );
                return totalRecord ? (totalRecord.totalSuspensions || 0) : 0;
            });

            const ctx = document.getElementById('enrollmentChart').getContext('2d');
            if (charts.enrollment) charts.enrollment.destroy();

            charts.enrollment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Enrollment',
                            data: enrollment,
                            backgroundColor: '#4A90C2',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Suspensions',
                            data: suspensions,
                            backgroundColor: '#FF8A65',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Enrollment'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Suspensions'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        function categorizeGroup(groupName) {
            const raceGroups = [
                'American Indian or Alaska Native',
                'Asian',
                'Black or African American',
                'African American',
                'Filipino',
                'Hispanic or Latino',
                'Native Hawaiian or Pacific Islander',
                'Pacific Islander',
                'Two or More Races',
                'White'
            ];

            const genderGroups = [
                'Male',
                'Female',
                'Non-Binary Gender (Beginning 2019-20)'
            ];

            if (raceGroups.includes(groupName)) return 'race';
            if (genderGroups.includes(groupName)) return 'gender';
            if (groupName === 'Total') return 'total';
            return 'other';
        }

        function getTop5SuspensionGroups(data) {
            const groupTotals = {};

            data.forEach(record => {
                const group = record.reportingCategoryDescription;
                if (group === 'Total') return; // Skip total

                if (!groupTotals[group]) {
                    groupTotals[group] = 0;
                }
                groupTotals[group] += (record.totalSuspensions || 0);
            });

            return Object.entries(groupTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0]);
        }

        function createGenderChart(data) {
            const comparisonType = document.getElementById('comparisonFilter').value;
            let groupsToCompare = [];
            let chartTitle = 'Group Comparison Over Time';

            if (comparisonType === 'gender') {
                groupsToCompare = ['Male', 'Female', 'Non-Binary Gender (Beginning 2019-20)'];
                chartTitle = 'Gender Categories';
            } else if (comparisonType === 'race') {
                const allGroups = [...new Set(data.map(d => d.reportingCategoryDescription))];
                groupsToCompare = allGroups.filter(g => categorizeGroup(g) === 'race');
                chartTitle = 'Race/Ethnicity Groups';
            } else if (comparisonType === 'other') {
                const allGroups = [...new Set(data.map(d => d.reportingCategoryDescription))];
                groupsToCompare = allGroups.filter(g => {
                    const category = categorizeGroup(g);
                    return category !== 'race' && category !== 'gender' && category !== 'total';
                });
                chartTitle = 'Other Categories';
            } else if (comparisonType === 'top5') {
                groupsToCompare = getTop5SuspensionGroups(data);
                chartTitle = 'Top 5 Highest Suspension Groups (by total incidents)';
            }

            const genderData = data.filter(d =>
                groupsToCompare.includes(d.reportingCategoryDescription)
            );

            const years = [...new Set(genderData.map(d => d.academicYear))].sort();

            // Color palette for multiple groups
            const colorPalette = [
                '#2C5F8D',  // Primary blue
                '#FF8A65',  // Accent orange
                '#9C27B0',  // Purple
                '#4CAF50',  // Green
                '#FFC107',  // Yellow
                '#E91E63',  // Pink
                '#00BCD4',  // Cyan
                '#FF5722',  // Deep Orange
                '#3F51B5',  // Indigo
                '#8BC34A'   // Light Green
            ];

            // Larger points for better visibility
            const pointRadius = years.length <= 2 ? 8 : (years.length <= 4 ? 6 : 4);
            const pointHoverRadius = pointRadius + 2;

            const datasets = groupsToCompare.map((group, idx) => {
                const data = years.map(year => {
                    const record = genderData.find(d =>
                        d.academicYear === year && d.reportingCategoryDescription === group
                    );
                    return record ? (record.suspensionRate * 100) : null;
                });

                const color = colorPalette[idx % colorPalette.length];
                const rgbaColor = color.replace('#', '').match(/.{2}/g).map(h => parseInt(h, 16));
                const backgroundColor = `rgba(${rgbaColor[0]}, ${rgbaColor[1]}, ${rgbaColor[2]}, 0.1)`;

                return {
                    label: group.replace(' (Beginning 2019-20)', ''),
                    data: data,
                    borderColor: color,
                    backgroundColor: backgroundColor,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: pointRadius,
                    pointHoverRadius: pointHoverRadius,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1
                };
            });

            const ctx = document.getElementById('genderChart').getContext('2d');
            if (charts.gender) charts.gender.destroy();

            charts.gender = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Suspension Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const tableBody = document.getElementById('tableBody');

            // Get selected years from checkboxes
            const checkedYears = Array.from(document.querySelectorAll('.tableYearCheckbox:checked'))
                .map(cb => cb.value);

            // Filter data by selected years
            let filteredData = allData.filter(d => checkedYears.includes(d.academicYear));

            // CRITICAL: Remove duplicate "Total" rows (keep only from base CSV)
            filteredData = filteredData.filter(d => {
                if (d.reportingCategoryDescription === 'Total') {
                    // Only include Total from base CSV
                    return d.sourceFile === 'ev2_DorothyCamp_DataSummary.csv' || !d.sourceFile;
                }
                return true;
            });

            // Sort by year (descending) then by group name
            filteredData.sort((a, b) => {
                const yearCompare = b.academicYear.localeCompare(a.academicYear);
                if (yearCompare !== 0) return yearCompare;

                // Put "Total" first within each year
                if (a.reportingCategoryDescription === 'Total') return -1;
                if (b.reportingCategoryDescription === 'Total') return 1;

                return a.reportingCategoryDescription.localeCompare(b.reportingCategoryDescription);
            });

            const rows = filteredData.map(d => {
                const isTotal = d.reportingCategoryDescription === 'Total';
                return `
                    <tr class="${isTotal ? 'highlight-total' : ''}">
                        <td>${d.academicYear}</td>
                        <td>${d.reportingCategoryDescription}</td>
                        <td>${d.cumulativeEnrollment !== null ? d.cumulativeEnrollment.toLocaleString() : 'N/A'}</td>
                        <td>${d.totalSuspensions !== null ? d.totalSuspensions.toLocaleString() : 'N/A'}</td>
                        <td>${d.uniqueStudentsSuspended !== null ? d.uniqueStudentsSuspended.toLocaleString() : 'N/A'}</td>
                        <td>${d.suspensionRate !== null ? (d.suspensionRate * 100).toFixed(1) + '%' : 'N/A'}</td>
                        <td>${d.suspensionsViolentWithInjury !== null ? d.suspensionsViolentWithInjury : 'N/A'}</td>
                        <td>${d.suspensionsViolentNoInjury !== null ? d.suspensionsViolentNoInjury : 'N/A'}</td>
                        <td>${d.suspensionsWeapons !== null ? d.suspensionsWeapons : 'N/A'}</td>
                        <td>${d.suspensionsDrugs !== null ? d.suspensionsDrugs : 'N/A'}</td>
                        <td>${d.suspensionsDefianceOnly !== null ? d.suspensionsDefianceOnly : 'N/A'}</td>
                        <td>${d.suspensionsOther !== null ? d.suspensionsOther : 'N/A'}</td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function downloadTableAsCSV() {
            // Get selected years from checkboxes
            const checkedYears = Array.from(document.querySelectorAll('.tableYearCheckbox:checked'))
                .map(cb => cb.value);

            // Filter data by selected years
            let dataToExport = allData.filter(d => checkedYears.includes(d.academicYear));

            // CRITICAL: Remove duplicate "Total" rows
            dataToExport = dataToExport.filter(d => {
                if (d.reportingCategoryDescription === 'Total') {
                    return d.sourceFile === 'ev2_DorothyCamp_DataSummary.csv' || !d.sourceFile;
                }
                return true;
            });

            // Sort by year then by group
            dataToExport.sort((a, b) => {
                const yearCompare = b.academicYear.localeCompare(a.academicYear);
                if (yearCompare !== 0) return yearCompare;
                if (a.reportingCategoryDescription === 'Total') return -1;
                if (b.reportingCategoryDescription === 'Total') return 1;
                return a.reportingCategoryDescription.localeCompare(b.reportingCategoryDescription);
            });

            // Create CSV content
            const headers = [
                'Academic Year',
                'Student Group',
                'Enrollment',
                'Total Suspensions',
                'Students Suspended',
                'Suspension Rate',
                'Violent (Injury)',
                'Violent (No Injury)',
                'Defiance Only',
                'Weapons',
                'Drugs',
                'Other',
                'Source File'
            ];

            const csvRows = [headers.join(',')];

            dataToExport.forEach(d => {
                const row = [
                    d.academicYear,
                    `"${d.reportingCategoryDescription}"`,
                    d.cumulativeEnrollment ?? 'N/A',
                    d.totalSuspensions ?? 'N/A',
                    d.uniqueStudentsSuspended ?? 'N/A',
                    d.suspensionRate !== null ? (d.suspensionRate * 100).toFixed(1) + '%' : 'N/A',
                    d.suspensionsViolentWithInjury ?? 'N/A',
                    d.suspensionsViolentNoInjury ?? 'N/A',
                    d.suspensionsDefianceOnly ?? 'N/A',
                    d.suspensionsWeapons ?? 'N/A',
                    d.suspensionsDrugs ?? 'N/A',
                    d.suspensionsOther ?? 'N/A',
                    d.sourceFile || 'Unknown'
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `dorothy_camp_suspension_data_${checkedYears.join('_')}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateGroupList(data) {
            const container = document.getElementById('groupList');
            if (!container) return;

            const groups = [...new Set(data.map(d => d.reportingCategoryDescription))].sort();
            if (!groups.length) {
                container.textContent = 'No student groups available for the current filters.';
                return;
            }

            container.innerHTML = `
                <strong>Groups in view:</strong> ${groups.join(', ')}
                <br><small>Group chart uses the latest available year for each listed group.</small>
            `;
        }

        function computeRaceAvailability() {
            const groups = new Set(allData.map(d => d.reportingCategoryDescription));
            missingRaceGroups = expectedRaceGroups.filter(group => !groups.has(group));
            updateRaceNotice();
        }

        function updateRaceNotice() {
            const notice = document.getElementById('raceNotice');
            if (!notice) return;

            const raceSourceMissing = !dataSources.race;

            if (raceSourceMissing) {
                notice.innerHTML = `
                    <strong>Race/Ethnicity data file missing:</strong> The race data sheet (ev2_DorothyCamp_DataSummary-RACE.csv)
                    could not be loaded. Please place it alongside the dashboard files so all race/ethnicity groups appear in the
                    filters and charts.
                `;
                return;
            }

            if (missingRaceGroups.length === expectedRaceGroups.length) {
                notice.innerHTML = `
                    <strong>Race/Ethnicity data unavailable:</strong> The combined data does not contain any race/ethnicity
                    categories (expected: ${expectedRaceGroups.join(', ')}). These groups cannot be displayed until they are
                    included in the source sheets.
                `;
                return;
            }

            if (missingRaceGroups.length) {
                notice.innerHTML = `
                    <strong>Partial race/ethnicity coverage:</strong> Missing categories from the source data:
                    ${missingRaceGroups.join(', ')}. All available categories from both sheets are included in the filters and
                    charts.
                `;
            } else {
                notice.innerHTML = `
                    <strong>Race/Ethnicity categories available:</strong> All expected race/ethnicity groups appear in the
                    combined data and respond to the filters above.
                `;
            }
        }

        // Initialize dashboard when page loads
        loadData();
    </script>
</body>
</html>
